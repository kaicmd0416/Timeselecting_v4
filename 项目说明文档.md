# 择时信号生成系统 (TimeSelecting_v3) 项目说明文档

## 1. 项目概述

本项目是一个量化择时信号生成系统，用于生成多层次的择时信号（L0、L1、L2、L3），并基于这些信号构建投资组合。系统通过数据准备、因子处理、信号构建、回测和组合构建等模块，实现自动化的择时信号生成和投资组合管理。

### 1.1 主要功能

- **数据准备**：从数据库获取原始数据并进行预处理
- **因子计算**：基于原始数据计算各类技术指标和基本面因子
- **信号生成**：生成L0、L1、L2、L3四个层级的择时信号
- **数据检查**：检查原始数据和生成信号的完整性
- **回测分析**：对因子和信号进行回测分析
- **组合构建**：基于信号构建投资组合

### 1.2 技术栈

- Python 3.x
- Pandas, NumPy
- YAML配置文件
- SQL数据库

## 2. 项目结构

```
Timeselecting_v3/
├── data/                      # 数据准备和处理模块
│   ├── data_prepare.py       # 原始数据获取
│   └── data_processing.py     # 数据加工和因子计算
├── factor_processing/         # 因子处理模块
│   └── signal_constructing.py # 信号构建逻辑
├── running_main/              # 信号生成主程序
│   ├── signal_construct_main.py  # 信号生成主控制器
│   ├── L0_signal_main.py     # L0级别信号生成
│   ├── L1_signal_main.py     # L1级别信号生成
│   ├── L2_signal_main.py     # L2级别信号生成
│   └── L3_signal_main.py     # L3级别信号生成
├── data_check/                # 数据检查模块
│   ├── data_check.py         # 数据完整性检查
│   └── config_checking.yaml  # 检查配置
├── backtesting/               # 回测模块
│   ├── factor_backtesting.py # 因子回测
│   └── signal_backtesting.py # 信号回测
├── portfolio/                 # 组合构建模块
│   └── portfolio_construction.py # 投资组合构建
├── config_project/            # 配置文件
│   ├── signal_dictionary.yaml # 信号字典配置
│   ├── portfolio.yaml         # 组合配置
│   └── timeselecting_sql.yaml # SQL配置
├── global_setting/            # 全局设置
│   └── global_dic.py         # 全局字典配置
├── signal_update_main.py      # 日常更新主程序
└── signal_history_main.py     # 历史数据生成主程序
```

## 3. 系统流程图

### 3.1 整体流程

```
┌─────────────────┐
│   开始运行       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 确定目标日期     │
│ target_date     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 数据完整性检查   │
│ RawDataChecker  │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 检查通过? │
    └────┬────┘
         │ 是
         ▼
┌─────────────────┐
│ 生成L1/L2/L3信号 │
│ signal_construct│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 信号完整性检查   │
│ SignalChecker   │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 检查通过? │
    └────┬────┘
         │ 是
         ▼
┌─────────────────┐
│ 生成L0信号       │
│ L0_signal_main  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ L0信号检查       │
│ SignalChecker   │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 检查通过? │
    └────┬────┘
         │ 是
         ▼
┌─────────────────┐
│ 构建投资组合     │
│ portfolio_      │
│ construction    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 组合检查         │
│ PortfolioChecker│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 信号回测         │
│ signal_backtest │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 完成             │
└─────────────────┘
```

### 3.2 信号生成流程

```
┌─────────────────┐
│ 读取信号配置     │
│ signal_dictionary│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 遍历信号类型     │
│ (L0/L1/L2/L3)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 对每个信号:      │
│ 1. 获取原始数据  │
│ 2. 计算因子      │
│ 3. 构建信号      │
│ 4. 保存到数据库  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 完成所有信号     │
└─────────────────┘
```

### 3.3 数据准备流程

```
┌─────────────────┐
│ data_prepare    │
│ 初始化          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 从数据库获取     │
│ 原始数据        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ data_processing │
│ 数据加工        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 计算各类因子     │
│ - 技术指标      │
│ - 基本面因子    │
│ - 宏观因子      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 返回处理后的数据 │
└─────────────────┘
```

## 4. 函数关系图

### 4.1 核心模块关系

```
signal_update_main.py (主入口)
    │
    ├──> target_date_decision()  # 确定目标日期
    │
    ├──> RawDataChecker (数据检查)
    │       ├──> check_data_prepare_functions()  # 检查data_prepare函数
    │       └──> check_raw_data()                # 检查原始数据
    │           └──> data_prepare.py
    │
    ├──> signal_constructing_main (信号生成控制器)
    │       ├──> get_factor_info()              # 获取因子信息
    │       ├──> running_main()                 # 运行主函数
    │       │
    │       ├──> L3_signalConstruction
    │       │       ├──> raw_data_preparing()   # 准备原始数据
    │       │       ├──> start_date_processing()# 处理开始日期
    │       │       └──> signal_main()          # 生成信号
    │       │           ├──> data_prepare.py
    │       │           ├──> data_processing.py
    │       │           └──> signal_constructing.py
    │       │
    │       ├──> L2_signalConstruction
    │       │       └──> L2_construction_main()
    │       │
    │       ├──> L1_signalConstruction
    │       │       └──> L1_construction_main()
    │       │
    │       └──> L0_signalConstruction
    │               └──> L0_construction_main()
    │
    ├──> SignalChecker (信号检查)
    │       └──> check_signal()                  # 检查信号完整性
    │
    ├──> portfolio_updating (组合构建)
    │       ├──> timeselecting_signalWithdraw() # 提取L0信号
    │       ├──> stock_portfolio_construction() # 构建股票组合
    │       ├──> etf_portfolio_construction()  # 构建ETF组合
    │       └──> portfolio_saving_main()        # 保存组合
    │
    └──> factor_backtesting (回测)
            └──> backtesting_main()             # 执行回测
```

### 4.2 数据流关系

```
data_prepare.py (数据准备层)
    │
    ├──> raw_shibor(period)          # Shibor利率数据
    ├──> raw_bond(period)            # 国债收益率
    ├──> raw_ZZGK(period)            # 国开债数据
    ├──> raw_ZZZD(period)            # 中债中短数据
    ├──> raw_M1M2(signal_name)       # 货币供应量
    ├──> raw_index_amt(index_name)    # 指数成交额
    ├──> raw_index_volume(index_name) # 指数成交量
    ├──> raw_index_close(index_name)  # 指数收盘价
    ├──> raw_index_weight(index_name) # 指数成分股
    ├──> raw_stockClose_withdraw()    # 股票收盘价
    ├──> raw_stockPct_withdraw()      # 股票涨跌幅
    ├──> raw_NetLeverageBuying_withdraw() # 融资融券数据
    ├──> raw_LargeOrder_withdraw()   # 大单数据
    ├──> raw_LHBProportion_withdraw() # 龙虎榜数据
    ├──> raw_CPI_withdraw()          # CPI数据
    ├──> raw_PPI_withdraw()          # PPI数据
    ├──> raw_PMI_withdraw()          # PMI数据
    ├──> raw_vix_withdraw()          # VIX数据
    ├──> raw_rrscore_withdraw()      # RR评分数据
    ├──> index_return_withdraw()     # 指数收益率
    └──> target_index()              # 目标指数
    │
    ▼
data_processing.py (数据处理层)
    │
    ├──> credit_spread_3M()          # 3个月信用利差
    ├──> credit_spread_9M()         # 9个月信用利差
    ├──> credit_spread_5Y()         # 5年信用利差
    ├──> term_spread_9Y()           # 9年期限利差
    ├──> M1M2()                     # M1-M2差值
    ├──> relativeVolume_std()       # 相对成交量标准差
    ├──> relativeReturn_std()       # 相对收益率标准差
    ├──> relativeTurnOver()         # 相对换手率
    ├──> LargeOrder_difference()    # 大单差异
    ├──> NetLeverageBuying()        # 净杠杆买入比例差异
    ├──> LHBProportion()            # 龙虎榜占比
    ├──> futureDifference()         # 期货价差差异
    ├──> rrscoreDifference()       # RR评分差异
    ├──> index_PB()                 # 指数PB相对值
    ├──> index_PE()                 # 指数PE相对值
    ├──> monthly_effect()           # 月度效应
    ├──> stock_highLow()            # 股票高低点信号
    ├──> stock_number()             # 涨跌停家数差值
    ├──> stock_rsi()                # 股票RSI差异
    ├──> stock_trend()              # 上涨趋势股票比例
    ├──> targetIndex_MACD()         # 目标指数MACD
    ├──> targetIndex_RSI()          # 目标指数RSI
    ├──> targetIndex_BOLLBAND()     # 目标指数布林带
    ├──> TargetIndex_KDJ()          # 目标指数KDJ
    └──> TargetIndex_PSA()          # 目标指数抛物线SAR
    │
    ▼
signal_constructing.py (信号构建层)
    │
    ├──> signal_construct类
    │       ├──> direction_decision(x)              # 方向决策1（正向）
    │       ├──> direction_decision2(x)             # 方向决策2（反向）
    │       ├──> MA_difference_signal_construct()  # 均线差异信号构建
    │       ├──> M1M2_signal_construct()           # M1M2信号构建
    │       ├──> Monthly_effect_signal_construct() # 月度效应信号构建
    │       └──> technical_signal_construct()      # 技术指标信号构建
    │
    └──> factor_processing类
            ├──> slice_processing()        # 数据切片处理
            ├──> slice_processing2()       # 数据切片处理2
            └──> slice_processing_Monthly()# 月度数据切片处理
    │
    ▼
L3_signal_main.py (L3信号生成)
    │
    ├──> raw_data_preparing()      # 准备原始数据，确定信号模式
    ├──> start_date_processing()   # 处理开始日期
    ├──> final_signal_construction() # 构建最终信号
    └──> signal_main()             # 信号生成主函数
    │
    ▼
L2_signal_main.py (L2信号生成)
    │
    └──> L2_construction_main()    # L2信号构建主函数
    │
    ▼
L1_signal_main.py (L1信号生成)
    │
    └──> L1_construction_main()    # L1信号构建主函数
    │
    ▼
L0_signal_main.py (L0信号生成)
    │
    └──> L0_construction_main()    # L0信号构建主函数
    │
    ▼
portfolio_construction.py (组合构建)
    │
    ├──> timeselecting_signalWithdraw() # 提取L0信号
    ├──> opt_portfolio_withdraw()      # 获取优化组合
    ├──> stock_portfolio_construction()# 构建股票组合
    ├──> etf_portfolio_construction() # 构建ETF组合
    ├──> future_portfolio_construction()# 构建期货组合
    └──> portfolio_saving_main()      # 保存组合
```

## 5. 主要模块说明

### 5.1 data_prepare.py

**功能**：从数据库获取原始数据

**主要函数**：
- `raw_shibor(period)`: 获取Shibor利率数据
- `raw_bond(period)`: 获取国债收益率数据
- `raw_index_amt(index_name)`: 获取指数成交额数据
- `raw_stockClose_withdraw()`: 获取股票收盘价数据
- `index_return_withdraw()`: 获取指数收益率数据

### 5.2 data_processing.py

**功能**：对原始数据进行加工，计算各类因子

**主要函数**：
- `credit_spread_3M()`: 计算3个月信用利差
- `M1M2()`: 计算M1-M2差值
- `NetLeverageBuying()`: 计算净杠杆买入比例差异
- `LargeOrder_difference()`: 计算大单差异
- `rrscoreDifference()`: 计算RR评分差异

### 5.3 signal_constructing.py

**功能**：基于因子数据构建择时信号

**主要函数**：
- `signal_construct()`: 信号构建主函数
- `factor_processing()`: 因子处理

### 5.4 L0/L1/L2/L3_signal_main.py

**功能**：生成不同层级的择时信号

**主要函数**：
- `raw_data_preparing()`: 准备原始数据
- `signal_main()`: 信号生成主函数
- `start_date_processing()`: 处理开始日期

### 5.5 data_check.py

**功能**：检查数据完整性

**主要类**：
- `RawDataChecker`: 检查原始数据完整性
- `SignalChecker`: 检查信号生成完整性
- `PortfolioChecker`: 检查投资组合完整性

## 6. 运行说明

### 6.1 环境配置

1. **Python环境**：Python 3.x
2. **依赖包**：
   - pandas
   - numpy
   - pyyaml
   - 其他项目特定依赖

3. **环境变量**：
   - 设置 `GLOBAL_TOOLSFUNC_new` 环境变量指向工具函数路径

4. **配置文件**：
   - 配置 `global_setting/global_dic.py` 中的数据库连接和路径
   - 配置 `config_project/` 下的YAML配置文件

### 6.2 日常更新运行

**主程序**：`signal_update_main.py`

**运行方式**：
```bash
python signal_update_main.py
```

**功能**：
- 自动确定目标日期
- 检查数据完整性
- 生成L1/L2/L3信号
- 生成L0信号
- 构建投资组合
- 执行回测

### 6.3 历史数据生成

**主程序**：`signal_history_main.py`

**运行方式**：
```bash
python signal_history_main.py
```

**功能**：
- 生成指定日期范围内的历史信号数据

### 6.4 单独运行信号生成

**示例**：生成L3信号
```python
from running_main.L3_signal_main import L3_signalConstruction

ssm = L3_signalConstruction(
    signal_name='NLBP_difference',
    mode='prod',
    start_date='2025-01-01',
    end_date='2025-12-31'
)
ssm.signal_main()
```

### 6.5 数据检查

**运行数据检查**：
```python
from data_check.data_check import RawDataChecker

checker = RawDataChecker(
    start_date='2025-01-01',
    end_date='2025-12-31'
)
results, status = checker.check_data_prepare_functions()
```

## 7. 配置说明

### 7.1 signal_dictionary.yaml

定义信号层级关系：
- L0_factor: L0级别因子
- L1_factor: L1级别因子
- L2_factor: L2级别因子
- L3_factor: L3级别因子

### 7.2 config_checking.yaml

定义数据检查配置：
- data_prepare_functions: 需要检查的data_prepare函数列表
- raw_data_paths: 原始数据路径配置

### 7.3 global_dic.py

全局配置字典：
- 数据库连接配置
- 数据路径配置
- SQL查询路径配置

## 8. 信号层级说明

### 8.1 L3信号

**特点**：最底层信号，基于原始因子计算
**示例**：`NLBP_difference`, `LargeOrder_difference`, `credit_spread_3M`

### 8.2 L2信号

**特点**：基于L3信号聚合
**示例**：由多个L3信号组合而成

### 8.3 L1信号

**特点**：基于L2信号聚合
**示例**：由多个L2信号组合而成

### 8.4 L0信号

**特点**：最终信号，基于L1信号生成
**示例**：最终的择时信号

## 9. 注意事项

1. **数据依赖**：确保数据库连接正常，数据完整
2. **日期格式**：统一使用 'YYYY-MM-DD' 格式
3. **工作日**：系统自动处理工作日，跳过非交易日
4. **错误处理**：各检查模块会在数据异常时抛出错误
5. **模式选择**：`mode='prod'` 为生产模式，`mode='test'` 为测试模式

## 10. 常见问题

### 10.1 数据为空错误

**原因**：数据源缺失或日期范围不正确
**解决**：检查数据源和日期范围

### 10.2 信号生成失败

**原因**：依赖的因子数据缺失
**解决**：检查前置因子的数据完整性

### 10.3 组合构建失败

**原因**：L0信号缺失
**解决**：确保L0信号已正确生成

## 11. 更新日志

- v3.0: 重构数据检查模块
- v3.0: 优化信号生成流程
- v3.0: 添加自动回测功能

---

**文档版本**：v1.0  
**最后更新**：2025年

